<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:CrunchyScroll.ViewModels"
             xmlns:models="clr-namespace:CrunchyScroll.Models"
             x:Class="CrunchyScroll.Views.ProductsPage"
             x:DataType="viewmodels:ProductsViewModel"
             Title="{Binding Title}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Winkelwagen" 
                     Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=GoToCartCommand}"/>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,Auto,*" Padding="10">

        <!-- Zoekbalk -->
        <SearchBar Grid.Row="0"
                   Placeholder="Zoek producten..."
                   Text="{Binding SearchText}"
                   Margin="0,0,0,10"/>

        <!-- Categorie filter -->
        <CollectionView Grid.Row="1" 
                       ItemsSource="{Binding Categories}"
                       SelectionMode="Single"
                       SelectedItem="{Binding SelectedCategory}"
                       Margin="0,0,0,10">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10"/>
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Category">
                    <Border StrokeThickness="1"
                            Padding="15,8"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20"/>
                        </Border.StrokeShape>
                        <Label Text="{Binding Name}"
                               TextColor="White"
                               FontAttributes="Bold"/>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Producten lijst -->
        <RefreshView Grid.Row="2" 
                     IsRefreshing="{Binding IsBusy}"
                     Command="{Binding LoadDataCommand}">
            <CollectionView ItemsSource="{Binding FilteredProducts}">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="2" HorizontalItemSpacing="10" VerticalItemSpacing="10"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Product">
                        <Border StrokeThickness="1" Padding="10">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer 
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ProductsViewModel}}, Path=ProductTappedCommand}"
                                    CommandParameter="{Binding .}"/>
                            </Border.GestureRecognizers>

                            <Grid RowDefinitions="120,Auto,Auto,Auto,Auto">
                                <!-- Product image -->
                                <Image Grid.Row="0"
                                       Source="{Binding ImageUrl}"
                                       Aspect="AspectFill"
                                       HeightRequest="120"
                                       Margin="0,0,0,5"/>

                                <Label Grid.Row="1"
                                       Text="{Binding Name}"
                                       FontAttributes="Bold"
                                       FontSize="16"
                                       Margin="0,10,0,5"/>

                                <Label Grid.Row="2"
                                       Text="{Binding Description}"
                                       FontSize="12"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="2"
                                       TextColor="{StaticResource Gray600}"
                                       Margin="0,0,0,5"/>

                                <Label Grid.Row="3"
                                       Text="{Binding Price, StringFormat='€{0:F2}'}"
                                       FontAttributes="Bold"
                                       FontSize="18"
                                       TextColor="{StaticResource Primary}"
                                       Margin="0,0,0,5"/>

                                <!-- Voorraad status -->
                                <Grid Grid.Row="4">
                                    <Label Text="✓ Op voorraad"
                                           TextColor="Green"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           IsVisible="{Binding IsInStock}"/>
                                    <Label Text="✗ Niet op voorraad"
                                           TextColor="Red"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           IsVisible="{Binding IsInStock, Converter={StaticResource InvertedBoolConverter}}"/>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center">
                        <Label Text="Geen producten gevonden"
                               FontSize="18"
                               TextColor="{StaticResource Gray600}"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- Loading indicator -->
        <ActivityIndicator Grid.Row="2"
                          IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"/>
    </Grid>
</ContentPage>
